<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reprogramar Cita | Salud Vital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center text-warning mb-4">Reprogramar Cita</h1>

        <form method="POST" class="bg-white p-4 rounded shadow-sm mx-auto" style="max-width: 700px;">
            <div class="mb-3">
                <label class="form-label">Cédula</label>
                <input class="form-control" value="{{ cita.cedula }}" readonly>
            </div>

            <div class="mb-3">
                <label class="form-label">Especialidad</label>
                <input class="form-control" value="{{ cita.especialidad }}" readonly>
            </div>

            <!-- ✅ Campo oculto para enviar la especialidad al servidor -->
            <input type="hidden" name="especialidad" value="{{ cita.especialidad }}">

            <div class="mb-3">
                <label class="form-label">Profesional</label>
                <select id="profesional" name="profesional" class="form-select" required></select>
            </div>

            <div class="mb-3">
                <label class="form-label">Nueva Fecha</label>
                <input id="fecha" type="date" name="fecha" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Nueva Hora</label>
                <select id="hora" name="hora" class="form-select" required>
                    <option value="">Seleccione fecha y profesional</option>
                </select>
            </div>

            <button type="submit" class="btn btn-warning w-100 mt-3">Reprogramar</button>
        </form>

        <div class="text-center mt-4">
            <a href="{{ url_for('cita.listar') }}" class="btn btn-outline-dark">Volver</a>
        </div>
    </div>

<script>
const ESPECIALIDADES = JSON.parse('{{ especialidades | tojson | safe }}');
const profesionalSelect = document.getElementById('profesional');
const fechaInput = document.getElementById('fecha');
const horaSelect = document.getElementById('hora');
const especialidad = "{{ cita.especialidad }}";
const profesionalActual = "{{ cita.profesional }}";

// Inicializar lista de profesionales
document.addEventListener('DOMContentLoaded', () => {
    profesionalSelect.innerHTML = '';
    ESPECIALIDADES[especialidad].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        if (p === profesionalActual) opt.selected = true;
        profesionalSelect.appendChild(opt);
    });
});

profesionalSelect.addEventListener('change', rellenarHoras);
fechaInput.addEventListener('change', rellenarHoras);

async function rellenarHoras() {
    const fecha = fechaInput.value;
    const profesional = profesionalSelect.value;
    horaSelect.innerHTML = '<option>Cargando...</option>';

    if (!fecha || !profesional) {
        horaSelect.innerHTML = '<option>Seleccione profesional y fecha</option>';
        return;
    }

    const resp = await fetch(`/cita/horas_disponibles?fecha=${fecha}&profesional=${encodeURIComponent(profesional)}`);
    const data = await resp.json();

    horaSelect.innerHTML = '';
    if (data.horas && data.horas.length) {
        data.horas.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h;
            opt.textContent = h;
            horaSelect.appendChild(opt);
        });
    } else {
        horaSelect.innerHTML = '<option>No hay horas disponibles</option>';
    }
}
</script>
</body>
</html>
